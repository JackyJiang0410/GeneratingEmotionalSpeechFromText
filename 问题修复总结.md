# F5-TTS 问题修复总结

## 问题描述

运行 `run_f5_batch.py` 时，所有音频生成都失败，错误信息：
```
TorchCodec is required for load_with_torchcodec. Please install torchcodec to use this function.
```

## 根本原因

1. **torchaudio 版本问题**：torchaudio 2.9.0 默认使用 `torchcodec` 来加载音频文件
2. **torchcodec 兼容性问题**：torchcodec 与 PyTorch 2.9.0 不兼容，无法正常加载
3. **progress 参数问题**：F5-TTS 代码使用 `progress.tqdm()`，需要正确的模块式接口

## 修复方案

### 1. 降级 torchaudio 和 torch

```bash
conda activate f5
pip install "torchaudio<2.5"
```

这会自动降级到：
- torch: 2.4.1
- torchaudio: 2.4.1

这个版本的 torchaudio 使用 soundfile 作为后端，不依赖 torchcodec。

### 2. 修复脚本中的 progress 参数

修改 `run_f5_batch.py`，创建一个兼容的 progress 模块：

```python
class NoProgressModule:
    @staticmethod
    def tqdm(x, **kwargs):
        kwargs['disable'] = True
        from tqdm import tqdm
        return tqdm(x, **kwargs)

progress_module = NoProgressModule()
```

### 3. 确保 ffmpeg 可用（可选）

虽然不直接相关，但确保 ffmpeg 正确配置也是好的：

```python
if os.path.exists("/opt/homebrew/bin/ffmpeg"):
    os.environ["FFMPEG_BINARY"] = "/opt/homebrew/bin/ffmpeg"
```

## 验证

运行脚本后，应该看到：
```
✓ Saved: outputs/f5/happy/f5-happy-01.wav
✓ Saved: outputs/f5/happy/f5-happy-02.wav
...
```

## 注意事项

1. **环境隔离**：确保在正确的 conda 环境中运行脚本
2. **版本兼容性**：PyTorch 和 torchaudio 版本需要匹配
3. **MPS 后端警告**：在 Mac M 系列芯片上，某些操作会回退到 CPU，这是正常的

## 当前配置

- Python: 3.11
- PyTorch: 2.4.1
- torchaudio: 2.4.1
- F5-TTS: 已安装（从本地目录）

脚本现在应该可以正常生成音频文件了！

